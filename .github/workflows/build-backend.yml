name: Build backend binaries

on:
  workflow_dispatch: {}
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    env:
      APP_NAME: LCSC2KiCad
      PYTHON_VERSION: "3.11"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set version
        shell: bash
        run: |
          if [[ "${GITHUB_REF_NAME}" == v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Set OS name (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          case "$RUNNER_OS" in
            Linux) OS_NAME="Linux" ;;
            macOS) OS_NAME="Mac" ;;
            *) OS_NAME="$RUNNER_OS" ;;
          esac
          echo "OS_NAME=$OS_NAME" >> "$GITHUB_ENV"

      - name: Set OS name (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          "OS_NAME=Windows" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Install dependencies (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyinstaller

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { pip install -r requirements.txt }
          pip install pyinstaller

      - name: Build PyInstaller binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          pyinstaller --onefile --name "$APP_NAME" run_server.py

      - name: Build PyInstaller binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          pyinstaller --onefile --name "$env:APP_NAME" run_server.py

      - name: Package artifact (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          mkdir -p out
          OUTPUT_NAME="${APP_NAME}-${VERSION}"
          cp "dist/$APP_NAME" "out/$OUTPUT_NAME"
          zip -j "out/${OUTPUT_NAME}-${OS_NAME}.zip" "out/$OUTPUT_NAME"

      - name: Package artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path out | Out-Null
          $OutputName = "$env:APP_NAME-$env:VERSION"
          Copy-Item "dist\\$env:APP_NAME.exe" "out\\$OutputName.exe"
          Compress-Archive -Path "out\\$OutputName.exe" -DestinationPath "out\\$OutputName-$env:OS_NAME.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LCSC2KiCad-${{ env.VERSION }}-${{ env.OS_NAME }}
          path: out/*

  package-extension:
    name: Package extension
    runs-on: ubuntu-latest
    env:
      EXT_DIR: chrome_extension
    steps:
      - uses: actions/checkout@v4

      - name: Set version
        shell: bash
        run: |
          if [[ "${GITHUB_REF_NAME}" == v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Verify extension manifest
        run: |
          test -d "$EXT_DIR" || { echo "Missing $EXT_DIR"; exit 1; }
          test -f "$EXT_DIR/manifest.json" || { echo "Missing manifest.json"; exit 1; }

      - name: Create extension zip
        run: |
          SRC="$EXT_DIR"
          if [ -d "$EXT_DIR/dist" ]; then SRC="$EXT_DIR/dist"; fi
          zip -r "LCSC2KiCad-${VERSION}-Chrome.zip" "$SRC" -x "**/node_modules/**" "**/.git/**" "**/.vscode/**" "**/*.map"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LCSC2KiCad-${{ env.VERSION }}-Chrome
          path: LCSC2KiCad-${{ env.VERSION }}-Chrome.zip

  release:
    name: Publish release
    runs-on: ubuntu-latest
    needs: [build, package-extension]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          merge-multiple: true

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
